graph TD
    User[User] -->|Provides Repo| PG[Prompt Generator / V2V]
    
    subgraph "Grazer Ecosystem"
        Grazer[Grazer Service]
        MCP[Grazer MCP Server]
        Grazer -->|Exposes Tools| MCP
    end

    subgraph "Refactoring Orchestration"
        PG -->|Coordination| AgentOrch[Agent Orchestrator]
    end

    subgraph "Microservice A (New)"
        AgentA[Agent A]
        ConfigA[AGENTS.md]
        CodeA[Source Code A]
        AgentA -->|Enforces Rules| ConfigA
        AgentA -->|Refactors| CodeA
    end

    subgraph "Microservice B (New)"
        AgentB[Agent B]
        ConfigB[AGENTS.md]
        CodeB[Source Code B]
        AgentB -->|Enforces Rules| ConfigB
        AgentB -->|Refactors| CodeB
    end

    %% Key Flow: PG talks to Grazer TWICE
    PG -->|1. Request Pre-Split Metrics| Grazer
    PG -->|2. Request Post-Split Metrics| Grazer
    Grazer -->|Returns Cyclometrics & Mermaid| PG

    PG -->|3. Compare & Explain| Diff[Improvement Report]
    
    AgentOrch -->|Spawns| AgentA
    AgentOrch -->|Spawns| AgentB

    %% A2A Communication
    AgentA <-->|A2A Protocol: Exchange Req Docs| AgentB
    
    %% Use MCP
    AgentA -.->|Calls Grazer Tools| MCP
    AgentB -.->|Calls Grazer Tools| MCP